<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jimmy's Fitness Heat Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }
        
        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 380px;
            background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #222;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }
        
        /* Stats Overview */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 20px 24px;
            border-bottom: 1px solid #222;
        }
        
        .stat-card {
            background: #161616;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #222;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }
        
        .stat-value.orange { color: #ff6b35; }
        .stat-value.green { color: #00d26a; }
        .stat-value.blue { color: #3b82f6; }
        .stat-value.purple { color: #a855f7; }
        
        .stat-unit {
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }
        
        /* Time Slider */
        .time-filter {
            padding: 20px 24px;
            border-bottom: 1px solid #222;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .filter-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        
        .filter-value {
            font-size: 13px;
            color: #ff6b35;
            font-weight: 500;
        }
        
        .time-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            background: #222;
            border-radius: 3px;
            outline: none;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
        }
        
        .time-range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }
        
        /* Activity Type Filter */
        .activity-filter {
            padding: 16px 24px;
            border-bottom: 1px solid #222;
        }
        
        .activity-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .activity-btn {
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid #333;
            background: transparent;
            color: #888;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .activity-btn:hover {
            border-color: #ff6b35;
            color: #ff6b35;
        }
        
        .activity-btn.active {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-color: transparent;
            color: #fff;
        }
        
        /* Workout Cards */
        .workouts-section {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .workout-count {
            background: #222;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #888;
        }
        
        .workout-card {
            background: #161616;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #222;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .workout-card:hover {
            border-color: #ff6b35;
            transform: translateY(-2px);
        }
        
        .workout-card.selected {
            border-color: #ff6b35;
            background: #1a1a1a;
        }
        
        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .workout-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .workout-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .workout-icon.walk { background: #00d26a22; }
        .workout-icon.run { background: #ff6b3522; }
        .workout-icon.cycle { background: #3b82f622; }
        .workout-icon.hike { background: #a855f722; }
        
        .workout-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        
        .workout-location {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .workout-date {
            font-size: 11px;
            color: #666;
        }
        
        .workout-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .workout-stat {
            text-align: center;
        }
        
        .workout-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .workout-stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #0a0a0a;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-btn {
            width: 44px;
            height: 44px;
            background: #161616;
            border: 1px solid #333;
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .map-btn:hover {
            background: #222;
            border-color: #ff6b35;
        }
        
        /* Heat Map Legend */
        .heatmap-legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: #161616ee;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            z-index: 1000;
        }
        
        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .legend-gradient {
            width: 150px;
            height: 12px;
            background: linear-gradient(90deg, #3b82f6 0%, #00d26a 33%, #f7931e 66%, #ff6b35 100%);
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #666;
        }
        
        /* Import Panel */
        /* Menu Button */
        .menu-button {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1100;
            background: #161616;
            border: 1px solid #333;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #fff;
            transition: all 0.2s;
        }
        
        .menu-button:hover {
            background: #222;
            transform: scale(1.05);
        }
        
        .menu-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 1100;
            background: #161616;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 8px;
            min-width: 200px;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        .menu-dropdown.show {
            display: block;
        }
        
        .menu-item {
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .menu-item:hover {
            background: #222;
        }
        
        .menu-item.primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }
        
        .menu-item.primary:hover {
            transform: scale(1.02);
        }
        
        .import-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .import-btn:hover {
            transform: scale(1.05);
        }
        
        .demo-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #333;
            border-radius: 8px;
            color: #888;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .demo-btn:hover {
            border-color: #ff6b35;
            color: #ff6b35;
        }
        
        /* World View Button */
        .world-view-btn {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .world-view-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Leaflet Overrides */
        .leaflet-control-zoom {
            display: none;
        }
        
        .leaflet-container {
            background: #0a0a0a;
        }
    
        /* Mobile Toggle Button */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
            transition: transform 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobile-toggle:active {
            transform: scale(0.95);
        }
        
        .mobile-toggle span {
            display: block;
            pointer-events: none;
        }
        
        /* Daily Breakdown */
        .daily-breakdown {
            padding: 20px 24px;
            border-bottom: 1px solid #222;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .daily-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .daily-breakdown-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        
        .date-picker-input {
            padding: 8px 12px;
            background: #161616;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }
        
        .daily-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #161616;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .daily-item:hover {
            background: #1a1a1a;
            border-left: 3px solid #ff6b35;
        }
        
        .daily-item-date {
            font-size: 13px;
            color: #888;
            font-weight: 500;
        }
        
        .daily-item-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .daily-stat {
            text-align: right;
        }
        
        .daily-stat-value {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }
        
        .daily-stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }
        
        @media (max-width: 768px) {
            #mobileToggle {
                display: flex !important;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-toggle {
                display: flex !important;
                align-items: center;
                justify-content: center;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                transition: left 0.3s ease;
                width: 100%;
                max-width: 100%;
                height: 100vh;
                z-index: 1500;
                overflow-y: auto;
            }
            
            .sidebar.show {
                left: 0 !important;
            }
            
            .map-container {
                width: 100% !important;
                height: 100vh !important;
            }
            
            /* Ensure sidebar starts hidden on mobile */
            body.mobile .sidebar:not(.show) {
                display: none;
            }
            
            body.mobile .sidebar.show {
                display: flex;
            }
        }

    </style>
</head>
<body>
    <!-- Mobile Toggle Button - COMPLETELY INLINE (no function dependencies) -->
    <button id="mobileToggle" style="
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 99999;
        background: #FF6B35;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        display: none;
        pointer-events: auto;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    ">
        üèÉ
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üèÉ</div>
                    <h1>FitMap</h1>
                </div>
                <p class="subtitle">Jimmy's Workout Heat Map</p>
            </div>
            
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Distance</div>
                    <div class="stat-value orange" id="totalDistance">0<span class="stat-unit"> mi</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Steps</div>
                    <div class="stat-value green" id="totalSteps">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Workouts</div>
                    <div class="stat-value blue" id="totalWorkouts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Calories</div>
                    <div class="stat-value purple" id="totalCalories">0</div>
                </div>
            </div>
            
            <!-- Date Range Filter -->
            <div class="time-filter">
                <div class="filter-header">
                    <span class="filter-title">Date Range</span>
                    <button class="filter-value" id="clearDateRange" style="background: none; border: none; color: #ff6b35; cursor: pointer; font-size: 12px; padding: 4px 8px;">Clear</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div>
                        <label style="display: block; font-size: 11px; color: #666; margin-bottom: 4px;">From</label>
                        <input type="date" class="date-picker-input" id="dateFrom" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: #666; margin-bottom: 4px;">To</label>
                        <input type="date" class="date-picker-input" id="dateTo" style="width: 100%;">
                    </div>
                </div>
            </div>
            
            <!-- Activity Filter -->
            <div class="activity-filter">
                <div class="activity-buttons">
                    <button class="activity-btn active" data-type="all">All</button>
                    <button class="activity-btn" data-type="walk">üö∂ Walk</button>
                    <button class="activity-btn" data-type="run">üèÉ Run</button>
                    <button class="activity-btn" data-type="cycle">üö¥ Cycle</button>
                    <button class="activity-btn" data-type="hike">ü•æ Hike</button>
                </div>
            </div>
            
            <!-- Workout Cards -->
            
        <!-- Daily Breakdown -->
        <div class="daily-breakdown">
            <div class="daily-breakdown-header">
                <span class="daily-breakdown-title">Daily Breakdown</span>
                <input type="date" class="date-picker-input" id="datePicker" />
            </div>
            <div id="dailyList">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div class="workouts-section">
                <div class="section-title">
                    Recent Workouts
                    <span class="workout-count" id="workoutCount">0</span>
                </div>
                <div id="workoutList"></div>
            </div>
        </div>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Import Panel -->
            <!-- Menu Button -->
            <div class="menu-button" id="menuButton" onclick="toggleMenu()">
                ‚öôÔ∏è
            </div>
            
            <!-- Menu Dropdown -->
            <div class="menu-dropdown" id="menuDropdown">
                <input type="file" id="fileInput" accept=".gpx,.xml,.json" style="display: none;">
                <button class="menu-item primary" onclick="document.getElementById('fileInput').click(); toggleMenu();">üìÅ Import File</button>
                <button class="menu-item" id="loadDemoBtn">üé® Load Demo</button>
                <button class="menu-item" id="showSetupBtn">‚öôÔ∏è Setup Auto-Sync</button>
            </div>
            
            <!-- Setup Modal -->
            <div id="setupModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
                <div style="background: #161616; border-radius: 16px; padding: 32px; max-width: 500px; margin: 20px; border: 1px solid #333;">
                    <h2 style="margin-bottom: 20px; color: #ff6b35;">‚öôÔ∏è Auto-Sync Setup</h2>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 14px; color: #fff; margin-bottom: 8px;">Step 1: Install Health Auto Export</h3>
                        <p style="font-size: 13px; color: #888; margin-bottom: 12px;">Download from the App Store ($2.99)</p>
                        <a href="https://apps.apple.com/app/health-auto-export-json-csv/id1115567069" target="_blank" style="display: inline-block; padding: 10px 20px; background: #3b82f6; color: #fff; border-radius: 8px; text-decoration: none; font-size: 13px;">üì± Open App Store</a>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 14px; color: #fff; margin-bottom: 8px;">Step 2: Configure Webhook URL</h3>
                        <p style="font-size: 13px; color: #888; margin-bottom: 12px;">In the app, set this as your REST API endpoint:</p>
                        <div style="background: #0a0a0a; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; color: #00d26a; word-break: break-all;" id="webhookUrl">
                            Loading...
                        </div>
                        <button onclick="copyWebhookUrl()" style="margin-top: 8px; padding: 8px 16px; background: #333; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;">üìã Copy URL</button>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 14px; color: #fff; margin-bottom: 8px;">Step 3: Select Data to Sync</h3>
                        <p style="font-size: 13px; color: #888;">Enable these in Health Auto Export:</p>
                        <ul style="font-size: 13px; color: #ccc; margin-top: 8px; padding-left: 20px;">
                            <li>‚úÖ Workouts (with route data)</li>
                            <li>‚úÖ Steps</li>
                            <li>‚úÖ Walking + Running Distance</li>
                            <li>‚úÖ Active Energy (Calories)</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 14px; color: #fff; margin-bottom: 8px;">Step 4: Enable Auto Export</h3>
                        <p style="font-size: 13px; color: #888;">Set the app to automatically export on a schedule (hourly recommended)</p>
                    </div>
                    
                    <button onclick="closeSetupModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">Got it!</button>
                </div>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-btn" id="zoomIn">+</button>
                <button class="map-btn" id="zoomOut">‚àí</button>
                <button class="map-btn" id="toggleHeat">üî•</button>
                <button class="map-btn" id="toggleSatellite">üõ∞Ô∏è</button>
            </div>
            
            <!-- World View Button -->
            <button class="world-view-btn" id="worldViewBtn">
                üåç World View
            </button>
            
            <!-- Legend -->
            <div class="heatmap-legend">
                <div class="legend-title">Activity Intensity</div>
                <div class="legend-gradient"></div>
                <div class="legend-labels">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
        // Mobile sidebar toggle
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.sidebar');
            const toggleIcon = document.getElementById('toggleIcon');
            const button = document.getElementById('mobileToggle');
            
            console.log('‚úÖ Toggle clicked!', {
                hasShow: sidebar.classList.contains('show'),
                width: window.innerWidth,
                buttonExists: !!button,
                sidebarExists: !!sidebar
            });
            
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                if (toggleIcon) toggleIcon.textContent = 'üìä';
                console.log('‚û°Ô∏è Hiding sidebar, showing map');
            } else {
                sidebar.classList.add('show');
                if (toggleIcon) toggleIcon.textContent = 'üó∫Ô∏è';
                console.log('‚¨ÖÔ∏è Showing sidebar, hiding map');
            }
        };
        
        // Initialize mobile detection
        function initMobile() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile');
                // Start with map view on mobile (sidebar hidden)
                document.querySelector('.sidebar').classList.remove('show');
                const toggleIcon = document.getElementById('toggleIcon');
                if (toggleIcon) toggleIcon.textContent = 'üìä';
            }
        }
        
        // Run on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMobile);
        } else {
            initMobile();
        }
        
        // Populate daily breakdown
        function populateDailyBreakdown(dailyStats) {
            const dailyList = document.getElementById('dailyList');
            if (!dailyStats || dailyStats.length === 0) {
                dailyList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; font-size: 13px;">No daily data available</div>';
                return;
            }
            
            // Sort by date descending
            const sorted = dailyStats.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            dailyList.innerHTML = sorted.map(day => `
                <div class="daily-item" onclick="highlightDay('${day.date}')">
                    <div class="daily-item-date">${formatDate(day.date)}</div>
                    <div class="daily-item-stats">
                        <div class="daily-stat">
                            <div class="daily-stat-value">${day.steps.toLocaleString()}</div>
                            <div class="daily-stat-label">Steps</div>
                        </div>
                        <div class="daily-stat">
                            <div class="daily-stat-value">${day.distance.toFixed(1)}</div>
                            <div class="daily-stat-label">Miles</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Highlight specific day
        function highlightDay(date) {
            console.log('Selected day:', date);
            const dailyItems = document.querySelectorAll('.daily-item');
            dailyItems.forEach(item => item.style.background = '#161616');
            event.currentTarget.style.background = '#1a1a1a';
        }
        
        // Date picker change handler
        document.addEventListener('DOMContentLoaded', () => {
            const datePicker = document.getElementById('datePicker');
            if (datePicker) {
                datePicker.addEventListener('change', (e) => {
                    const selectedDate = e.target.value;
                    highlightDay(selectedDate);
                });
            }
        });

    </script>
    <!-- Leaflet Heat Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        // Initialize map centered on Garden Grove
        const map = L.map('map', {
            center: [33.7743, -117.9379],
            zoom: 12,
            zoomControl: false
        });
        
        // Dark tile layer
        const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
        
        // Satellite layer (hidden by default)
        const satelliteTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });
        
        let currentTiles = 'dark';
        let heatLayer = null;
        let routeLayers = [];
        let workouts = [];
        let selectedWorkoutId = null;
        
        // Demo workout data (Garden Grove and around the world)
        const demoWorkouts = [
            {
                id: 1,
                type: 'walk',
                name: 'Morning Walk',
                location: 'Garden Grove, CA',
                date: '2026-01-25',
                distance: 2.3,
                steps: 4800,
                duration: 35,
                calories: 180,
                route: [
                    [33.7743, -117.9379], [33.7750, -117.9360], [33.7765, -117.9345],
                    [33.7780, -117.9330], [33.7790, -117.9350], [33.7775, -117.9370],
                    [33.7760, -117.9385], [33.7743, -117.9379]
                ]
            },
            {
                id: 2,
                type: 'run',
                name: 'Evening Run',
                location: 'Mile Square Park',
                date: '2026-01-24',
                distance: 3.8,
                steps: 6200,
                duration: 28,
                calories: 320,
                route: [
                    [33.7134, -117.9428], [33.7150, -117.9400], [33.7180, -117.9380],
                    [33.7200, -117.9400], [33.7180, -117.9450], [33.7150, -117.9460],
                    [33.7134, -117.9428]
                ]
            },
            {
                id: 3,
                type: 'walk',
                name: 'Lunch Walk',
                location: 'Fountain Valley, CA',
                date: '2026-01-23',
                distance: 1.5,
                steps: 3200,
                duration: 22,
                calories: 120,
                route: [
                    [33.7092, -117.9536], [33.7100, -117.9520], [33.7115, -117.9510],
                    [33.7105, -117.9530], [33.7092, -117.9536]
                ]
            },
            {
                id: 4,
                type: 'hike',
                name: 'Weekend Hike',
                location: 'Crystal Cove, Newport',
                date: '2026-01-19',
                distance: 5.2,
                steps: 11000,
                duration: 95,
                calories: 520,
                route: [
                    [33.5667, -117.8333], [33.5680, -117.8300], [33.5700, -117.8280],
                    [33.5720, -117.8260], [33.5740, -117.8280], [33.5720, -117.8310],
                    [33.5690, -117.8340], [33.5667, -117.8333]
                ]
            },
            {
                id: 5,
                type: 'cycle',
                name: 'Beach Bike Ride',
                location: 'Huntington Beach',
                date: '2026-01-18',
                distance: 12.5,
                steps: 0,
                duration: 55,
                calories: 480,
                route: [
                    [33.6603, -117.9992], [33.6650, -117.9980], [33.6700, -117.9950],
                    [33.6750, -117.9920], [33.6800, -117.9900], [33.6850, -117.9880],
                    [33.6800, -117.9900], [33.6750, -117.9920], [33.6700, -117.9950],
                    [33.6603, -117.9992]
                ]
            },
            {
                id: 6,
                type: 'run',
                name: 'Tokyo Morning Run',
                location: 'Yoyogi Park, Tokyo',
                date: '2025-12-15',
                distance: 4.2,
                steps: 7000,
                duration: 32,
                calories: 380,
                route: [
                    [35.6717, 139.6949], [35.6730, 139.6970], [35.6750, 139.6990],
                    [35.6740, 139.7010], [35.6720, 139.6990], [35.6717, 139.6949]
                ]
            },
            {
                id: 7,
                type: 'walk',
                name: 'NYC Central Park',
                location: 'Central Park, NYC',
                date: '2025-11-20',
                distance: 3.5,
                steps: 7200,
                duration: 50,
                calories: 280,
                route: [
                    [40.7812, -73.9665], [40.7830, -73.9650], [40.7850, -73.9630],
                    [40.7840, -73.9610], [40.7820, -73.9640], [40.7812, -73.9665]
                ]
            },
            {
                id: 8,
                type: 'hike',
                name: 'Paris City Walk',
                location: 'Champs-√âlys√©es, Paris',
                date: '2025-10-10',
                distance: 4.8,
                steps: 9800,
                duration: 75,
                calories: 400,
                route: [
                    [48.8698, 2.3078], [48.8710, 2.3100], [48.8730, 2.3150],
                    [48.8720, 2.3180], [48.8700, 2.3140], [48.8698, 2.3078]
                ]
            },
            {
                id: 9,
                type: 'run',
                name: 'Sydney Harbor Run',
                location: 'Sydney, Australia',
                date: '2025-09-05',
                distance: 5.0,
                steps: 8200,
                duration: 38,
                calories: 420,
                route: [
                    [-33.8568, 151.2153], [-33.8550, 151.2180], [-33.8530, 151.2200],
                    [-33.8540, 151.2170], [-33.8568, 151.2153]
                ]
            },
            {
                id: 10,
                type: 'walk',
                name: 'London Eye Walk',
                location: 'London, UK',
                date: '2025-08-15',
                distance: 2.8,
                steps: 5800,
                duration: 42,
                calories: 220,
                route: [
                    [51.5033, -0.1195], [51.5050, -0.1170], [51.5070, -0.1150],
                    [51.5060, -0.1180], [51.5033, -0.1195]
                ]
            }
        ];
        
        // Format numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Get workout icon
        function getWorkoutIcon(type) {
            const icons = { walk: 'üö∂', run: 'üèÉ', cycle: 'üö¥', hike: 'ü•æ' };
            return icons[type] || 'üèÉ';
        }
        
        // Get route color
        function getRouteColor(type) {
            const colors = { walk: '#00d26a', run: '#ff6b35', cycle: '#3b82f6', hike: '#a855f7' };
            return colors[type] || '#ff6b35';
        }
        
        // Update stats
        function updateStats() {
            const totalDistance = workouts.reduce((sum, w) => sum + w.distance, 0);
            const totalSteps = workouts.reduce((sum, w) => sum + w.steps, 0);
            const totalCalories = workouts.reduce((sum, w) => sum + w.calories, 0);
            
            document.getElementById('totalDistance').innerHTML = `${totalDistance.toFixed(1)}<span class="stat-unit"> mi</span>`;
            document.getElementById('totalSteps').textContent = formatNumber(totalSteps);
            document.getElementById('totalWorkouts').textContent = workouts.length;
            document.getElementById('totalCalories').textContent = formatNumber(totalCalories);
            document.getElementById('workoutCount').textContent = workouts.length;
        }
        
        // Render workout cards
        function renderWorkoutCards() {
            const container = document.getElementById('workoutList');
            container.innerHTML = workouts.map(w => `
                <div class="workout-card ${selectedWorkoutId === w.id ? 'selected' : ''}" data-id="${w.id}">
                    <div class="workout-header">
                        <div class="workout-type">
                            <div class="workout-icon ${w.type}">${getWorkoutIcon(w.type)}</div>
                            <div>
                                <div class="workout-name">${w.name}</div>
                                <div class="workout-location">${w.location}</div>
                            </div>
                        </div>
                        <div class="workout-date">${new Date(w.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                    </div>
                    <div class="workout-stats">
                        <div class="workout-stat">
                            <div class="workout-stat-value">${w.distance}</div>
                            <div class="workout-stat-label">Miles</div>
                        </div>
                        <div class="workout-stat">
                            <div class="workout-stat-value">${w.duration}</div>
                            <div class="workout-stat-label">Minutes</div>
                        </div>
                        <div class="workout-stat">
                            <div class="workout-stat-value">${w.calories}</div>
                            <div class="workout-stat-label">Calories</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.workout-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = parseInt(card.dataset.id);
                    selectWorkout(id);
                });
            });
        }
        
        // Select workout
        function selectWorkout(id) {
            selectedWorkoutId = id;
            const workout = workouts.find(w => w.id === id);
            if (workout && workout.route.length > 0) {
                const bounds = L.latLngBounds(workout.route);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            renderWorkoutCards();
            renderRoutes();
        }
        
        // Render routes on map
        function renderRoutes() {
            // Clear existing routes
            routeLayers.forEach(layer => map.removeLayer(layer));
            routeLayers = [];
            
            // Add routes
            workouts.forEach(workout => {
                if (workout.route.length > 0) {
                    const polyline = L.polyline(workout.route, {
                        color: getRouteColor(workout.type),
                        weight: selectedWorkoutId === workout.id ? 5 : 3,
                        opacity: selectedWorkoutId === workout.id ? 1 : 0.6
                    }).addTo(map);
                    
                    polyline.on('click', () => selectWorkout(workout.id));
                    routeLayers.push(polyline);
                    
                    // Add start marker
                    const startMarker = L.circleMarker(workout.route[0], {
                        radius: 6,
                        fillColor: getRouteColor(workout.type),
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(map);
                    routeLayers.push(startMarker);
                }
            });
        }
        
        // Update heat map
        function updateHeatMap() {
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }
            
            const heatData = [];
            workouts.forEach(workout => {
                workout.route.forEach(point => {
                    heatData.push([point[0], point[1], 0.5]);
                });
            });
            
            if (heatData.length > 0) {
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    gradient: {
                        0.4: '#3b82f6',
                        0.6: '#00d26a',
                        0.8: '#f7931e',
                        1.0: '#ff6b35'
                    }
                }).addTo(map);
            }
        }
        
        // Load workouts
        function loadWorkouts(data) {
            workouts = data;
            updateStats();
            renderWorkoutCards();
            renderRoutes();
            updateHeatMap();
        }
        
        // Menu toggle
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('show');
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('menuDropdown');
            const menuButton = document.getElementById('menuButton');
            if (menu && menuButton && !menu.contains(e.target) && !menuButton.contains(e.target)) {
                menu.classList.remove('show');
            }
        });
        
        // Event Listeners
        document.getElementById('loadDemoBtn').addEventListener('click', () => {
            allWorkouts = demoWorkouts; // Store for filtering
            loadWorkouts(demoWorkouts);
            toggleMenu(); // Close menu after action
        });
        
        document.getElementById('worldViewBtn').addEventListener('click', () => {
            map.setView([20, 0], 2);
        });
        
        document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());
        
        document.getElementById('toggleHeat').addEventListener('click', () => {
            if (heatLayer) {
                if (map.hasLayer(heatLayer)) {
                    map.removeLayer(heatLayer);
                } else {
                    map.addLayer(heatLayer);
                }
            }
        });
        
        document.getElementById('toggleSatellite').addEventListener('click', () => {
            if (currentTiles === 'dark') {
                map.removeLayer(darkTiles);
                map.addLayer(satelliteTiles);
                currentTiles = 'satellite';
            } else {
                map.removeLayer(satelliteTiles);
                map.addLayer(darkTiles);
                currentTiles = 'dark';
            }
        });
        
        // Activity filter
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const type = btn.dataset.type;
                if (type === 'all') {
                    applyDateRangeFilter(); // Apply current date filter
                } else {
                    // Apply both activity type and date filter
                    const fromDate = document.getElementById('dateFrom').value;
                    const toDate = document.getElementById('dateTo').value;
                    const from = fromDate ? new Date(fromDate + 'T00:00:00') : new Date('1900-01-01');
                    const to = toDate ? new Date(toDate + 'T23:59:59') : new Date('2100-12-31');
                    
                    const filtered = allWorkouts.filter(w => {
                        const workoutDate = new Date(w.date);
                        return w.type === type && workoutDate >= from && workoutDate <= to;
                    });
                    loadWorkouts(filtered);
                }
            });
        });
        
        // Date range filtering
        let allWorkouts = []; // Store all workouts for filtering
        let allDailyData = []; // Store all daily data for filtering
        let originalStats = null; // Store original stats from API
        
        async function applyDateRangeFilter() {
            const fromDate = document.getElementById('dateFrom').value;
            const toDate = document.getElementById('dateTo').value;
            
            // Only apply filter if BOTH dates are selected OR both are empty (show all)
            if ((fromDate && !toDate) || (!fromDate && toDate)) {
                console.log('Waiting for both From and To dates...');
                return; // Don't filter until both dates are selected
            }
            
            const from = fromDate ? new Date(fromDate + 'T00:00:00') : new Date('1900-01-01');
            const to = toDate ? new Date(toDate + 'T23:59:59') : new Date('2100-12-31');
            
            // Filter workouts
            if (!fromDate && !toDate) {
                loadWorkouts(allWorkouts);
            } else {
                const filteredWorkouts = allWorkouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= from && workoutDate <= to;
                });
                loadWorkouts(filteredWorkouts);
                console.log(`Filtered ${filteredWorkouts.length} of ${allWorkouts.length} workouts`);
            }
            
            // Filter daily data and recalculate stats ONLY if a filter is active
            if (!fromDate && !toDate) {
                // No filter - restore original stats from API
                if (originalStats) {
                    document.getElementById('totalSteps').textContent = formatNumber(originalStats.totalSteps);
                    document.getElementById('totalDistance').innerHTML = `${originalStats.totalDistance.toFixed(1)}<span class="stat-unit"> mi</span>`;
                    document.getElementById('totalCalories').textContent = formatNumber(originalStats.totalCalories);
                    document.getElementById('totalWorkouts').textContent = originalStats.totalDays || originalStats.totalWorkouts;
                    console.log('Restored original stats (no filter active)');
                }
                
                // Show all daily data
                if (allDailyData.length > 0) {
                    updateDailyList(allDailyData);
                }
            } else if (allDailyData.length > 0) {
                // Filter is active - recalculate from filtered daily data
                const filteredDaily = allDailyData.filter(d => {
                    const dailyDate = new Date(d.date + 'T00:00:00');
                    return dailyDate >= from && dailyDate <= to;
                });
                
                // Recalculate totals from filtered daily data
                const totalSteps = filteredDaily.reduce((sum, d) => sum + (d.steps || 0), 0);
                const totalDistance = filteredDaily.reduce((sum, d) => sum + (d.distance || 0), 0);
                const totalCalories = filteredDaily.reduce((sum, d) => sum + (d.calories || 0), 0);
                
                // Update stats display
                document.getElementById('totalSteps').textContent = formatNumber(totalSteps);
                document.getElementById('totalDistance').innerHTML = `${totalDistance.toFixed(1)}<span class="stat-unit"> mi</span>`;
                document.getElementById('totalCalories').textContent = totalCalories > 0 ? formatNumber(totalCalories) : '0';
                document.getElementById('totalWorkouts').textContent = filteredDaily.length;
                
                // Update daily list
                updateDailyList(filteredDaily);
                
                console.log(`Stats recalculated: ${totalSteps} steps, ${totalDistance.toFixed(1)} mi, ${totalCalories} cal (${filteredDaily.length} days)`);
            }
        }
        
        document.getElementById('dateFrom').addEventListener('change', applyDateRangeFilter);
        document.getElementById('dateTo').addEventListener('change', applyDateRangeFilter);
        
        document.getElementById('clearDateRange').addEventListener('click', () => {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            applyDateRangeFilter();
        });
        
        // File import
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    // Parse GPX or JSON
                    const content = event.target.result;
                    if (file.name.endsWith('.json')) {
                        try {
                            const data = JSON.parse(content);
                            loadWorkouts(data);
                        } catch (err) {
                            alert('Error parsing JSON file');
                        }
                    } else if (file.name.endsWith('.gpx')) {
                        // Basic GPX parsing
                        alert('GPX import coming soon! Use JSON format for now.');
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // ============== API INTEGRATION ==============
        
        const API_BASE = window.location.origin;
        
        // Fetch workouts from API
        async function fetchWorkouts() {
            try {
                const response = await fetch(`${API_BASE}/api/workouts`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        allWorkouts = data; // Store for filtering
                        loadWorkouts(data);
                        updateSyncStatus('Live');
                        return true;
                    }
                }
            } catch (err) {
                console.log('API not available, using demo mode');
            }
            return false;
        }
        
        // Fetch stats from API
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    originalStats = stats; // Store original stats for when no filter is active
                    
                    document.getElementById('totalDistance').innerHTML = 
                        `${stats.totalDistance.toFixed(1)}<span class="stat-unit"> mi</span>`;
                    document.getElementById('totalSteps').textContent = formatNumber(stats.totalSteps);
                    document.getElementById('totalWorkouts').textContent = stats.totalDays || stats.totalWorkouts;
                    document.getElementById('totalCalories').textContent = formatNumber(stats.totalCalories);
                    
                    // Update workout count label to "Days" if we have daily data
                    if (stats.totalDays > 0) {
                        const label = document.querySelector('#totalWorkouts').closest('.stat-card').querySelector('.stat-label');
                        if (label) label.textContent = 'Days Tracked';
                    }
                    
                    if (stats.lastSync) {
                        updateSyncStatus('Synced ' + new Date(stats.lastSync).toLocaleTimeString());
                    }
                    
                    return true;
                }
            } catch (err) {
                console.log('Could not fetch stats');
            }
            return false;
        }
        
        // Fetch daily data from API
        async function fetchDailyData() {
            try {
                const response = await fetch(`${API_BASE}/api/daily`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        allDailyData = data; // Store for filtering
                        console.log(`Fetched ${data.length} days of data`);
                        
                        // Update daily breakdown list
                        updateDailyList(data);
                        
                        return true;
                    }
                }
            } catch (err) {
                console.log('Could not fetch daily data');
            }
            return false;
        }
        
        // Update daily breakdown list
        function updateDailyList(dailyData) {
            const list = document.getElementById('dailyList');
            if (!list) return;
            
            // Sort by date descending
            const sorted = dailyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map(day => `
                <div style="padding: 12px; border-bottom: 1px solid #222;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-size: 13px; color: #fff; font-weight: 500;">${new Date(day.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</span>
                        <span style="font-size: 12px; color: #00d26a; font-weight: 600;">${formatNumber(day.steps)} steps</span>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 11px; color: #888;">
                        <span>üö∂ ${day.distance.toFixed(2)} mi</span>
                        ${day.calories > 0 ? `<span>üî• ${formatNumber(day.calories)} cal</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Update sync status display
        function updateSyncStatus(status) {
            let syncEl = document.getElementById('syncStatus');
            if (!syncEl) {
                syncEl = document.createElement('div');
                syncEl.id = 'syncStatus';
                syncEl.style.cssText = 'font-size: 11px; color: #00d26a; margin-top: 8px; display: flex; align-items: center; gap: 6px;';
                document.querySelector('.subtitle').after(syncEl);
            }
            syncEl.innerHTML = `<span style="width: 8px; height: 8px; background: #00d26a; border-radius: 50%; display: inline-block;"></span> ${status}`;
        }
        
        // Auto-refresh data every 30 seconds
        function startAutoRefresh() {
            setInterval(async () => {
                await fetchWorkouts();
                await fetchStats();
                await fetchDailyData();
                // Reapply filters to show updated data
                await applyDateRangeFilter();
            }, 30000);
        }
        
        // Initialize - try API first, fall back to demo
        async function init() {
            const hasWorkouts = await fetchWorkouts();
            // Always fetch stats (even without workouts, we may have daily step data)
            const hasStats = await fetchStats();
            // Fetch daily data for date range filtering
            const hasDailyData = await fetchDailyData();
            
            if (hasWorkouts || hasStats || hasDailyData) {
                startAutoRefresh();
            }
            // If no API data, user can click "Load Demo" or import manually
        }
        
        // Run on page load
        init();
        
        // Setup mobile toggle - multiple methods to ensure it works
        function setupMobileToggle() {
            const mobileToggle = document.getElementById('mobileToggle');
            console.log('Setting up mobile toggle:', {
                buttonExists: !!mobileToggle,
                buttonVisible: mobileToggle ? window.getComputedStyle(mobileToggle).display : 'not found'
            });
            
            if (mobileToggle) {
                // Method 1: Click event
                mobileToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üîµ Button clicked via addEventListener');
                    window.toggleSidebar();
                });
                
                // Method 2: Touch event for mobile
                mobileToggle.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    console.log('üì± Button touched via touchend');
                    window.toggleSidebar();
                });
                
                console.log('‚úÖ Mobile toggle listeners attached');
            } else {
                console.error('‚ùå Mobile toggle button not found!');
            }
        }
        
        // Run setup immediately and after DOM loads
        setupMobileToggle();
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupMobileToggle);
        }
        
        // Setup modal functions
        document.getElementById('showSetupBtn').addEventListener('click', () => {
            document.getElementById('setupModal').style.display = 'flex';
            document.getElementById('webhookUrl').textContent = `${window.location.origin}/api/webhook/health`;
        });
        
        function closeSetupModal() {
            document.getElementById('setupModal').style.display = 'none';
        }
        
        function copyWebhookUrl() {
            const url = `${window.location.origin}/api/webhook/health`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Webhook URL copied to clipboard!');
            });
        }
        
        // Close modal on background click
        document.getElementById('setupModal').addEventListener('click', (e) => {
            if (e.target.id === 'setupModal') {
                closeSetupModal();
            }
        });
    </script>

    <!-- Backup: Attach listeners via JavaScript too -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('mobileToggle');
            if (btn) {
                console.log('‚úÖ Mobile toggle button found, attaching backup listeners');
                
                // Remove any existing listeners to avoid conflicts
                btn.replaceWith(btn.cloneNode(true));
                const cleanBtn = document.getElementById('mobileToggle');
                
                cleanBtn.addEventListener('touchstart', function(e) {
                    console.log('üì± Touchstart fired');
                    this.style.transform = 'scale(0.95)';
                }, {passive: true});
                
                cleanBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    console.log('üì± Touchend fired - toggling sidebar');
                    this.style.transform = 'scale(1)';
                    
                    const sidebar = document.querySelector('.sidebar');
                    if (!sidebar) {
                        console.error('‚ùå Sidebar not found');
                        return;
                    }
                    
                    const wasVisible = sidebar.classList.contains('show');
                    sidebar.classList.toggle('show');
                    const isVisible = sidebar.classList.contains('show');
                    
                    console.log('‚úÖ Sidebar toggled:', wasVisible ? 'visible‚Üíhidden' : 'hidden‚Üívisible');
                }, {passive: false});
                
                cleanBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üñ±Ô∏è Click fired (desktop fallback)');
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.toggle('show');
                        console.log('‚úÖ Sidebar toggled via click');
                    }
                });
                
                console.log('‚úÖ All backup listeners attached');
            } else {
                console.error('‚ùå Mobile toggle button NOT found in DOM');
            }
        });
    </script>

</body>
</html>
